# 复习平台通用框架

## 项目结构

```
review-platform/
├── package.json          # Vite + React 依赖
├── vite.config.ts        # Vite 配置
├── tsconfig.json         # TypeScript 配置
├── index.html            # 入口 HTML
└── src/
    ├── main.tsx          # 应用入口
    ├── App.tsx           # 路由配置（多科目）
    ├── App.css           # 样式
    ├── types/
    │   └── index.ts      # 类型定义
    ├── data/
    │   └── subjects.ts   # 科目配置
    ├── context/
    │   └── SubjectContext.tsx  # 科目上下文（隔离进度）
    ├── hooks/
    │   ├── useProgress.ts      # 进度管理
    │   ├── useQuestions.ts     # 题目筛选
    │   ├── useWeakPoints.ts    # 薄弱点计算
    │   └── useExams.ts         # 试卷管理
    ├── components/
    │   ├── Layout.tsx          # 布局（科目切换+功能导航）
    │   ├── Latex.tsx           # LaTeX 渲染
    │   └── OverlayCanvas.tsx   # 手写画板
    └── pages/
        ├── Dashboard.tsx       # 总览
        ├── Practice.tsx        # 题库训练
        ├── Knowledge.tsx       # 知识点卡片
        ├── Formulas.tsx        # 公式背诵
        ├── BigQuestions.tsx    # 大题背诵
        ├── Mistakes.tsx        # 错题本
        ├── Exams.tsx           # 模拟考试列表
        └── ExamTake.tsx        # 答题页
```

---

## 多科目支持

### 科目配置 SubjectConfig

```typescript
interface SubjectConfig {
  id: string              // 科目标识（用于路由和存储）
  name: string            // 科目名称
  chapters: { id: string; name: string }[]  // 章节列表
}

// 示例配置
const subjects: SubjectConfig[] = [
  {
    id: 'physics',
    name: '大学物理',
    chapters: [
      { id: '01', name: '力学' },
      { id: '02', name: '热学' },
      { id: '03', name: '电磁学' },
      { id: '04', name: '光学' },
      { id: '05', name: '量子物理' },
    ]
  },
  {
    id: 'mechanics',
    name: '理论力学',
    chapters: [
      { id: '01', name: '静力学' },
      { id: '02', name: '运动学' },
      { id: '03', name: '动力学' },
      { id: '04', name: '分析力学' },
    ]
  },
  {
    id: 'probability',
    name: '概率论',
    chapters: [
      { id: '01', name: '概率论基础' },
      { id: '02', name: '随机变量' },
      { id: '03', name: '数字特征' },
      { id: '04', name: '大数定律' },
      { id: '05', name: '数理统计' },
    ]
  }
]
```

### 科目数据 SubjectData

```typescript
interface SubjectData {
  questions: Question[]
  knowledgePoints: KnowledgePoint[]
  formulas: Formula[]
  bigQuestions: BigQuestion[]
  bigQuestionImageGroups: BigQuestionImageGroup[]
}
```

### 科目隔离机制

- **路由隔离**：`/:subjectId/practice`、`/:subjectId/exams` 等
- **存储隔离**：`review-{subjectId}-progress`、`review-{subjectId}-exams`
- **上下文切换**：SubjectContext 根据 URL 参数切换科目数据和进度

---

## 数据模型

### 核心类型

```typescript
type ID = string
type Chapter = string
type Difficulty = 1 | 2 | 3 | 4 | 5
type QuestionType = 'fill' | 'single' | 'truefalse' | 'short' | 'calc'
type MasteryState = 'known' | 'unsure' | 'unknown'
```

### 知识点 KnowledgePoint

```typescript
interface KnowledgePoint {
  id: ID
  title: string
  chapter: Chapter
  types: QuestionType[]      // 可能出现的题型
  body: string               // 知识点详细内容
  formulas: ID[]             // 关联公式
  examples: ID[]             // 关联例题
  difficulty: Difficulty
  freqScore: number          // 高频指数（用于薄弱点计算）
}
```

### 公式 Formula

```typescript
interface Formula {
  id: ID
  latex: string              // LaTeX 公式
  chapter: Chapter
  mnemonic?: string          // 记忆口诀
  usage?: string             // 用途说明
  kp: ID[]                   // 关联知识点
}
```

### 题目 Question

```typescript
interface Question {
  id: ID
  qtype: QuestionType
  stem: string               // 题干
  options?: string[]         // 选项（单选/判断）
  answer: string | string[]  // 答案
  analysis?: string          // 解析
  kp: ID[]                   // 关联知识点
  source?: string            // 来源
  difficulty?: Difficulty
}
```

### 大题 BigQuestion

```typescript
interface BigQuestion {
  id: ID
  groupId: string            // 题组（同一道大题的多个小问）
  chapter: Chapter
  topic: string              // 小题标题
  prompt: string             // 问题
  summary: string[]          // 答案要点
  details?: string[]         // 详细解答
  tags?: ('theory' | 'calc' | 'procedure')[]
}
```

### 试卷 GeneratedExam

```typescript
interface GeneratedExam {
  id: string
  createdAt: number
  title: string
  timeLimit: number          // 分钟
  questions: ID[]
  drawings: Record<ID, string>  // 草稿画板数据
  startedAt?: number
  finishedAt?: number
  elapsedTime?: number
}
```

### 用户进度 UserProgress

```typescript
interface QuestionProgress {
  state: MasteryState
  attempts: number
  correct: number
  lastAnsweredAt?: number
}

interface KnowledgePointProgress {
  reviews: number
  lastReviewedAt?: number
}

interface UserProgress {
  version: 1
  updatedAt: number
  question: Record<ID, QuestionProgress>
  kp: Record<ID, KnowledgePointProgress>
  favorites: ID[]
}
```

---

## 功能模块

### 1. 复习总览 Dashboard

- 统计卡片：题库总数、已练习、已掌握、知识点数
- 分值分布饼图（ECharts）
- 薄弱点 Top N 列表
- 快速开始按钮（按题型跳转练习）

### 2. 题库训练 Practice

- 题型筛选（全部/填空/单选/判断/简答/计算）
- 收藏筛选
- 进度显示（当前题号/总数）
- 题目卡片：
  - 题干展示
  - 选项点击（单选/判断自动判分）
  - 显示答案按钮（主观题）
  - 答案+解析展示
  - 关联知识点标签（可展开详情）
  - 关联公式查看
- 自评按钮：会/不熟/不会
- 收藏/取消收藏
- 标记已掌握
- 上一题/下一题导航

### 3. 知识点卡片库 Knowledge

- 章节筛选
- 知识点卡片列表：
  - 章节标签
  - 标题
  - 难度等级
  - 展开后显示：详细内容、关联公式、题型、高频指数

### 4. 公式背诵 Formulas

- 章节筛选
- 遮挡模式/显示全部切换
- 公式卡片：
  - 章节标签
  - 用途说明
  - LaTeX 公式（点击显示/隐藏）
  - 记忆口诀
  - 关联知识点

### 5. 大题背诵 BigQuestions

- 章节筛选
- 背诵进度统计
- 遮挡全部/显示全部
- 题组卡片：
  - 题组标题
  - 题图查看（可展开）
  - 小题列表：
    - 标签（理论/计算/步骤）
    - 问题
    - 答案要点（点击显示/隐藏）
    - 详解（可展开）
- 背诵进度持久化

### 6. 错题与薄弱点 Mistakes

- 薄弱知识点表格：
  - 知识点名称
  - 正确率
  - 薄弱指数
  - 距上次复习天数
- 错题列表（状态为 unknown/unsure 的题目）
- 再练一遍错题
- 重置学习记录

### 7. 模拟考试 Exams

**试卷列表页：**
- 生成新试卷按钮
- 重置题库（清除已用题目记录）
- 试卷卡片：创建时间、题数、时限、用时、开始/继续/查看

**试卷配置弹窗：**
- 各题型数量配置
- 可用题目数显示
- 考试时间设置
- 是否包含已掌握题目

**答题页 ExamTake：**
- 计时器（超时提示）
- 交卷按钮
- 答题统计（已答/正确/错误）
- 题号进度条（点击跳转，状态着色）
- 题目卡片：
  - 收藏按钮
  - 查看公式
  - 选项选择/文本输入
  - 提交答案/查看答案/跳过
  - 答案+解析
  - 本题判定（答对/答错）
  - 掌握程度标记
- 草稿画板（OverlayCanvas）
- 答案持久化

---

## 核心算法

### 薄弱点计算

```typescript
// 遗忘系数（基于艾宾浩斯遗忘曲线）
function forgettingCoefficient(days: number): number {
  if (!Number.isFinite(days)) return 1.4
  if (days <= 1) return 0.3
  if (days <= 3) return 0.6
  if (days <= 7) return 0.85
  if (days <= 14) return 1.0
  if (days <= 30) return 1.15
  return 1.3
}

// 知识点权重
function weightForKP(kp: KnowledgePoint): number {
  const diffFactor = 0.8 + 0.1 * kp.difficulty
  return kp.freqScore * diffFactor
}

// 薄弱指数 = 权重 × (1 - 正确率) × 遗忘系数
weakness = W × (1 - accuracy) × R
```

### 掌握状态转换

```typescript
function nextMasteryState(prev: MasteryState, isCorrect: boolean): MasteryState {
  if (isCorrect) {
    return prev === 'unknown' ? 'unsure' : 'known'
  }
  return prev === 'known' ? 'unsure' : 'unknown'
}
```

---

## 技术栈

- React + TypeScript
- React Router（路由）
- ECharts（图表）
- KaTeX（LaTeX 渲染）
- localStorage（数据持久化）
- Canvas + Pointer Events（草稿画板）

---

## 手写画板组件

### DrawingCanvas（独立画板）

固定尺寸画板，用于独立草稿区域。

```typescript
interface DrawingCanvasProps {
  initialData?: string      // base64 初始图像
  onSave: (dataUrl: string) => void
  disabled?: boolean
}
```

### OverlayCanvas（覆盖层画板）

全屏覆盖层画板，用于答题时在题目上方手写。

```typescript
interface OverlayCanvasProps {
  initialData?: string
  onSave: (dataUrl: string) => void
  disabled?: boolean
  drawingEnabled: boolean   // 是否启用绘制模式
  onToggleDrawing: () => void
}
```

### 画板核心特性

**绑定事件**
- `onPointerDown` - 开始绘制，捕获指针
- `onPointerMove` - 绘制中，收集点位
- `onPointerUp` - 结束绘制，释放指针
- `onPointerLeave/Cancel` - 异常结束处理

**点位数据结构**
```typescript
interface Point {
  x: number
  y: number
  pressure: number  // 压感（0-1）
}
```

**平滑绘制算法**
```typescript
// 二次贝塞尔曲线平滑
for (let i = 1; i < points.length - 1; i++) {
  const p0 = points[i - 1]
  const p1 = points[i]
  const p2 = points[i + 1]

  const midX1 = (p0.x + p1.x) / 2
  const midY1 = (p0.y + p1.y) / 2
  const midX2 = (p1.x + p2.x) / 2
  const midY2 = (p1.y + p2.y) / 2

  ctx.beginPath()
  ctx.moveTo(midX1, midY1)
  ctx.quadraticCurveTo(p1.x, p1.y, midX2, midY2)
  ctx.stroke()
}
```

**压感支持**
```typescript
// 压感平滑（避免抖动）
const PRESSURE_SMOOTHING = 0.3
smoothedPressure = smoothedPressure * (1 - PRESSURE_SMOOTHING) + rawPressure * PRESSURE_SMOOTHING

// 线宽 = 基础粗细 × 压感
lineWidth = brushSize * pressure * 2
```

**性能优化**
- `requestAnimationFrame` 批量渲染
- `getCoalescedEvents()` 获取合并事件（高刷屏支持）
- 最小距离过滤（避免过密点位）
- 延迟保存（500-800ms 防抖）

**橡皮擦实现**
```typescript
ctx.globalCompositeOperation = isEraser ? 'destination-out' : 'source-over'
```

**高 DPI 适配**
```typescript
const dpr = window.devicePixelRatio || 1
canvas.width = width * dpr
canvas.height = height * dpr
ctx.setTransform(dpr, 0, 0, dpr, 0, 0)
```

**工具配置**
```typescript
const COLORS = ['#000000', '#e74c3c', '#3498db', '#27ae60', '#f39c12', '#9b59b6']
const BRUSH_SIZES = [2, 4, 6, 8, 12]
const ERASER_SIZES = [10, 20, 30, 40]
```

---

## 试卷管理 Hook

### useExams

```typescript
interface ExamConfig {
  fill: number
  single: number
  truefalse: number
  short: number
  calc: number
  timeLimit: number
}

interface ExamGenerateOptions {
  progress?: UserProgress
  includeKnown?: boolean    // 是否包含已掌握题目
}

function useExams(allQuestions: Question[]) {
  return {
    exams: GeneratedExam[]
    generateExam: (config, options?) => GeneratedExam | null
    getAvailableCounts: (options?) => Record<QuestionType, number>
    updateExam: (examId, updates) => void
    saveDrawing: (examId, questionId, dataUrl) => void
    deleteExam: (examId) => void
    resetUsedQuestions: () => void  // 重置已用题目池
  }
}
```

**题目去重机制**
- 维护 `usedQuestionIds` 集合
- 生成试卷时排除已用题目
- 删除试卷时归还题目到可用池
- 支持手动重置题库

---

## 路由结构

```
/:subjectId                    Dashboard（总览）
/:subjectId/practice           Practice（题库训练）
/:subjectId/big                BigQuestions（大题背诵）
/:subjectId/knowledge          Knowledge（知识点卡片）
/:subjectId/formulas           Formulas（公式背诵）
/:subjectId/mistakes           Mistakes（错题薄弱点）
/:subjectId/exams              Exams（模拟考试列表）
/:subjectId/exam/:examId       ExamTake（答题页）
```

---

## 数据持久化

| Key | 内容 |
|-----|------|
| `review-{subjectId}-progress` | 用户学习进度 |
| `review-{subjectId}-exams` | 生成的试卷列表 |
| `review-{subjectId}-used-questions` | 已用题目 ID 集合 |
| `exam-answers-{examId}` | 单场考试答案记录 |
| `review-bq-revealed-{subjectId}` | 大题背诵进度 |

---

## 核心 Hooks

### useProgress

```typescript
function useProgress() {
  return {
    progress: UserProgress
    recordAttempt: (questionId, kpIds, isCorrect, manualState?) => void
    setQuestionState: (questionId, state) => void
    resetProgress: () => void
    toggleFavorite: (questionId) => void
    isFavorite: (questionId) => boolean
  }
}
```

### useWeakPoints

```typescript
interface WeakPointItem {
  kp: KnowledgePoint
  weakness: number        // 薄弱指数
  accuracy: number        // 正确率
  daysSinceReview: number // 距上次复习天数
}

function useWeakPoints(
  kps: KnowledgePoint[],
  questions: Question[],
  progress: UserProgress,
  topN?: number
): WeakPointItem[]
```

### useQuestions

```typescript
function useQuestions(
  questions: Question[],
  options: { qtypes?: QuestionType[] }
): Question[]
```

---

## 布局组件

### Layout

```typescript
const navItems = [
  { to: '/', label: '总览' },
  { to: '/practice', label: '题库训练' },
  { to: '/big', label: '大题背诵' },
  { to: '/exams', label: '模拟考试' },
  { to: '/knowledge', label: '知识点' },
  { to: '/formulas', label: '公式背诵' },
  { to: '/mistakes', label: '错题本' },
]
```

使用 `NavLink` 实现导航高亮，`Outlet` 渲染子路由。

---

## 扩展建议

1. **云端同步**：将 localStorage 替换为后端 API
2. **错题本导出**：生成 PDF/Markdown
3. **学习计划**：基于薄弱点自动生成复习计划
4. **题目录入工具**：批量导入 Excel/JSON

---

## 添加新科目

1. 在 `src/data/subjects.ts` 中添加科目配置：

```typescript
{
  id: 'newsubject',
  name: '新科目名称',
  chapters: [
    { id: '01', name: '第一章' },
    { id: '02', name: '第二章' },
  ]
}
```

2. 在 `subjectDataMap` 中添加科目数据：

```typescript
const subjectDataMap: Record<string, SubjectData> = {
  // ...existing
  newsubject: {
    questions: [],
    knowledgePoints: [],
    formulas: [],
    bigQuestions: [],
    bigQuestionImageGroups: []
  }
}
```

3. 填充题目数据即可使用

---

## 运行项目

```bash
cd review-platform
npm install
npm run dev
```

访问 `http://localhost:5173`，顶部导航可切换科目。